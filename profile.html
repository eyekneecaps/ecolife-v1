<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Profile – EcoLife</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#0a192a; color:#fff; }

    /* === NAV (pixel-match to leaderboard) === */
    .topnav {
      display:flex; justify-content:space-between; align-items:center;
      padding:1rem; background:#000; color:#fff;
    }
    .nav-center { font-size:1.2rem; font-weight:700; }
    .gear { font-size:1.5rem; cursor:pointer; }
    .nav-links { display:flex; gap:1rem; align-items:center; }
    .topnav a,
    .topnav a:visited { color:#fff !important; text-decoration:none; }
    .topnav a:hover { text-decoration:underline; }
    .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:white; }
    @media (max-width:600px){
      .hamburger { display:block; }
      .nav-links { display:none; }
      .nav-dropdown {
        display:none; position:absolute; right:1rem; top:3.5rem;
        background:#073763; flex-direction:column; padding:1rem; border-radius:6px; z-index:999;
      }
      .nav-dropdown.show { display:flex; }
      .nav-dropdown a { color:white; margin:.5rem 0; text-decoration:none; }
    }

    /* === Card === */
    .container { max-width:640px; margin:3rem auto; padding:2rem; background:#07121f; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .info-row { margin-bottom:1rem; }
    .info-label { font-weight:700; margin-right:6px; }
    .uid { font-family:ui-monospace, Menlo, Consolas, monospace; color:#00ff99; }
    .btn { display:inline-block; margin:.35rem .25rem; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-size:15px; transition:.2s; }
    .btn:hover { opacity:.85; }
    .btn-back { background:#444; color:white; }
    .btn-logout { background:#e74c3c; color:white; }
    .btn-reset { background:#3498db; color:white; }
    .btn-unlink { background:#f39c12; color:white; display:none; } /* JS flips to inline-block */
    .hint { opacity:.8; font-size:.9rem; }
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="topnav">
    <div class="nav-left">
      <span class="gear" onclick="location.href='profile.html'">⚙️</span>
    </div>
    <div class="nav-center"><strong>EcoLife</strong></div>
    <div class="nav-right nav-links">
      <a href="index.html">About</a>
      <a href="products.html">Services</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="signup.html" id="signupLink">Sign Up</a>
      <a href="login.html"  id="loginLink">Login</a>
    </div>
    <button class="hamburger" onclick="toggleMobileNav()">☰</button>
  </nav>

  <!-- Mobile dropdown -->
  <div class="nav-dropdown" id="mobileDropdown">
    <a href="index.html">About</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLinkMobile">Sign Up</a>
    <a href="login.html"  id="loginLinkMobile">Login</a>
  </div>

  <!-- Profile card -->
  <div class="container">
    <h2>Your Profile</h2>

    <div class="info-row"><span class="info-label">Name:</span> <span id="name">Loading…</span></div>
    <div class="info-row"><span class="info-label">Email:</span> <span id="email">Loading…</span></div>
    <div class="info-row"><span class="info-label">RFID Linked:</span> <span id="rfid" class="uid">Checking…</span></div>
    <div class="info-row"><span class="info-label">User ID:</span> <span id="uid" class="uid">—</span></div>

    <div class="hint">Points shown live from <code>linked_uids/&lt;rfid&gt;/points</code>.</div>

    <div style="margin-top:1rem">
      <button class="btn btn-back" onclick="location.href='dashboard.html'">← Back to Dashboard</button>
      <button class="btn btn-reset" onclick="resetPassword()">Reset Password</button>
      <button id="unlinkBtn" class="btn btn-unlink" onclick="unlinkRFID()">Unlink RFID</button>
      <button class="btn btn-logout" onclick="logout()">Log Out</button>
    </div>
  </div>

  <!-- App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, set, update, remove, query, orderByChild, equalTo, runTransaction } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
      authDomain: "ecolife--v1.firebaseapp.com",
      databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ecolife--v1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const nameEl    = document.getElementById("name");
    const emailEl   = document.getElementById("email");
    const uidEl     = document.getElementById("uid");
    const rfidEl    = document.getElementById("rfid");
    const unlinkBtn = document.getElementById("unlinkBtn");

    // --- Nav helpers ---
    window.toggleMobileNav = () =>
      document.getElementById("mobileDropdown").classList.toggle("show");

    function updateAuthNav(isLoggedIn){
      const show = (id, on)=>{ const el=document.getElementById(id); if(el) el.style.display = on? "": "none"; };
      show("signupLink", !isLoggedIn);
      show("loginLink",  !isLoggedIn);
      show("signupLinkMobile", !isLoggedIn);
      show("loginLinkMobile",  !isLoggedIn);
    }

    // --- Points watcher ---
    let pointsUnsub = null;
    function detachPoints(){ if(pointsUnsub){ try{ pointsUnsub(); }catch{} pointsUnsub=null; } }
    function watchPoints(rfid){
      detachPoints();
      if(!rfid) return;
      const pRef = ref(db, `linked_uids/${rfid}/points`);
      pointsUnsub = onValue(pRef, (snap)=>{
        const pts = snap.exists()? snap.val(): 0;
        rfidEl.textContent = `${rfid} (Points: ${pts})`;
      }, (err)=>{
        console.warn("points listener error:", err?.message);
        rfidEl.textContent = `${rfid} (Points: —)`;
      });
    }

    // --- Robust link function (transaction; handles legacy strings) ---
    async function linkRFIDTransaction(rfid){
      const user = auth.currentUser;
      if (!user) throw new Error("Not logged in");
      const mapRef = ref(db, `rfid_to_user/${rfid}`);

      const res = await runTransaction(mapRef, (current) => {
        if (current === null) return { uid: user.uid };           // claim
        if (typeof current === "string") {
          if (current === user.uid) return { uid: user.uid };      // convert legacy self
          return;                                                  // someone else → abort
        }
        if (current && typeof current === "object" && current.uid === user.uid) {
          return current;                                          // idempotent
        }
        return;                                                    // someone else → abort
      }, { applyLocally:false });

      if (!res.committed) throw new Error("This RFID is already linked to another account.");

      await Promise.all([
        update(ref(db, `users/${user.uid}`), { rfid }),
        update(ref(db, `linked_uids/${rfid}`), { points: 0 })
      ]);
      return rfid;
    }
    // Usage example (call when you actually link): await linkRFIDTransaction('46AA4680');

    // --- RFID lookup (indexed query) ---
    async function getRFIDForUser(userId){
      const q = query(ref(db, "rfid_to_user"), orderByChild("uid"), equalTo(userId));
      const snap = await get(q);
      if (!snap.exists()) return null;
      const obj = snap.val();
      return Object.keys(obj)[0] || null;
    }

    // --- Unlink cleanup ---
    async function cleanupUnlinkForUser(userId){
      const rfidSnap = await get(ref(db, `users/${userId}/rfid`));
      if (!rfidSnap.exists() || !rfidSnap.val()) throw new Error("No RFID linked to this account.");
      const rfid = rfidSnap.val();

      const linkedRef = ref(db, `linked_uids/${rfid}`);
      const linkedSnap = await get(linkedRef);
      if (linkedSnap.exists()){
        await set(ref(db, `unlinked_uids/${rfid}`), linkedSnap.val());
        await remove(linkedRef);
      }

      await remove(ref(db, `rfid_to_user/${rfid}`));     // owner-only delete (rules allow)
      await remove(ref(db, `users/${userId}/events`)).catch(()=>{});
      await update(ref(db, `users/${userId}`), { rfid:null, rfid_uid:null, points:0 });
      return rfid;
    }

    async function unlinkRFID(){
      try{
        const user = auth.currentUser;
        if(!user) { alert("Not logged in."); return; }
        const rfid = await cleanupUnlinkForUser(user.uid);
        detachPoints();
        rfidEl.textContent = "Not linked";
        unlinkBtn.style.display = "none";
        alert(`RFID ${rfid} unlinked and cleaned.`);
      }catch(e){
        alert("Unlink failed: " + (e?.message || e));
      }
    }
    window.unlinkRFID = unlinkRFID;

    // --- Auth + profile load ---
    onAuthStateChanged(auth, async (user)=>{
      const loggedIn = !!user;
      document.cookie = `loggedIn=${loggedIn}; path=/`;
      updateAuthNav(loggedIn);

      if (!user){ location.href = "login.html"; return; }

      nameEl.textContent  = user.displayName || user.email || "User";
      emailEl.textContent = user.email || "—";
      uidEl.textContent   = user.uid;

      const userRef = ref(db, `users/${user.uid}`);
      onValue(userRef, async (snap)=>{
        const data = snap.val() || {};
        let rfid = data.rfid || null;

        if (!rfid){
          try {
            const recovered = await getRFIDForUser(user.uid);
            if (recovered){
              rfid = recovered;
              try { await update(userRef, { rfid: recovered }); } catch(_) {}
            }
          } catch(e){ console.warn(e); }
        }

        if (rfid){
          unlinkBtn.style.display = "inline-block";
          watchPoints(rfid);
        } else {
          unlinkBtn.style.display = "none";
          detachPoints();
          rfidEl.textContent = "Not linked";
        }
      }, (err)=> console.warn("users listener error:", err?.message));
    });

    // --- Account helpers ---
    window.logout = () => signOut(auth).then(()=> location.href="login.html");
    window.resetPassword = () => {
      const u = auth.currentUser;
      if (u?.email) {
        sendPasswordResetEmail(auth, u.email)
          .then(()=>alert("Password reset email sent to " + u.email))
          .catch(err=>alert("Error: " + (err?.message||err)));
      } else {
        alert("No email for this account.");
      }
    };
  </script>
</body>
</html>
