<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Profile – EcoLife</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; padding:0; background:#0a192a; color:white; }
    .topnav { display:flex; justify-content:space-between; align-items:center; padding:1rem; background-color:#000; }
    .gear { font-size:1.5rem; cursor:pointer; color:white; }
    .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:white; }
    @media (max-width:600px) {
      .hamburger { display:block; }
      .nav-dropdown { display:none; position:absolute; right:1rem; top:3.5rem; background:#073763; flex-direction:column; padding:1rem; border-radius:6px; z-index:999; }
      .nav-dropdown.show { display:flex; }
      .nav-dropdown a { color:white; margin:0.5rem 0; text-decoration:none; }
    }

    .container {
      max-width: 600px;
      margin: 4rem auto;
      padding: 2rem;
      border-radius: 12px;
      background: #07121f;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .info-row { margin-bottom: 1rem; }
    .info-label { font-weight: bold; margin-right: 6px; }
    .uid { font-family: monospace; color: #00ff99; }

    .btn {
      display: block;
      margin: 10px 0;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-back { background: #444; color: white; }
    .btn-logout { background: #e74c3c; color: white; }
    .btn-reset { background: #3498db; color: white; }
    .btn-unlink { background: #f39c12; color: white; }
  </style>
</head>
<body>

<nav class="topnav">
  <div class="nav-left"><span class="gear" onclick="toggleSettings()">⚙️</span></div>
  <div class="nav-center">EcoLife</div>
  <div class="nav-right desktop-links">
    <a href="index.html">About Us</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
  </div>
  <button class="hamburger" onclick="toggleMobileNav()">☰</button>
</nav>

<div class="nav-dropdown" id="mobileDropdown">
  <a href="index.html">About Us</a>
  <a href="products.html">Services</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="leaderboard.html">Leaderboard</a>
</div>

<div class="container">
  <h2>Your Profile</h2>
  <div class="info-row">
    <span class="info-label">Name:</span>
    <span id="name">Loading...</span>
  </div>
  <div class="info-row">
    <span class="info-label">Email:</span>
    <span id="email">Loading...</span>
  </div>
  <div class="info-row">
    <span class="info-label">RFID Linked:</span>
    <span id="rfid" class="uid">Checking...</span>
  </div>
  <div class="info-row">
    <span class="info-label">User ID:</span>
    <span id="uid" class="uid">---</span>
  </div>

  <button class="btn btn-back" onclick="window.location.href='dashboard.html'">← Back to Dashboard</button>
  <button class="btn btn-reset" onclick="resetPassword()">Reset Password</button>
  <button id="unlinkBtn" class="btn btn-unlink" style="display:none;" onclick="unlinkRFID()">Unlink RFID</button>
  <button class="btn btn-logout" onclick="logout()">Log Out</button>
</div>

<script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { getDatabase, ref, onValue, get, set, update, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
  authDomain: "ecolife--v1.firebaseapp.com",
  databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ecolife--v1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUID = null;
let linkedRFID = null;

// Helper to fetch points for a UID
async function fetchUIDPoints(rfid) {
  if (!rfid) return 0;

  // Check linked first
  const linkedSnap = await get(ref(db, `linked_uids/${rfid}/points`));
  if (linkedSnap.exists()) return linkedSnap.val();

  // If not linked, check unlinked
  const unlinkedSnap = await get(ref(db, `unlinked_uids/${rfid}/points`));
  if (unlinkedSnap.exists()) return unlinkedSnap.val();

  return 0;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }

  currentUID = user.uid;
  document.getElementById("name").textContent = user.displayName || user.email || "User";
  document.getElementById("email").textContent = user.email;
  document.getElementById("uid").textContent = user.uid;

  const userRef = ref(db, 'users/' + user.uid);
  onValue(userRef, async (snapshot) => {
    const data = snapshot.val() || {};
    linkedRFID = data?.rfid || null;
    document.getElementById("rfid").textContent = linkedRFID || "Not linked";
    document.getElementById("unlinkBtn").style.display = linkedRFID ? "block" : "none";

    // Fetch points from the UID itself
    const points = await fetchUIDPoints(linkedRFID);
    if (linkedRFID) {
      document.getElementById("rfid").textContent = `${linkedRFID} (Points: ${points})`;
    }
  });
});

// Unlink RFID but keep points in UID
window.unlinkRFID = async () => {
  if (!currentUID) { alert("You must be logged in to unlink RFID."); return; }

  const userRef = ref(db, `users/${currentUID}/rfid`);
  const snapshot = await get(userRef);
  if (!snapshot.exists()) { alert("No RFID linked to this account."); return; }

  const rfid = snapshot.val();
  try {
    // Remove RFID and user points
    await update(ref(db, `users/${currentUID}`), { rfid: null, points: 0 });

    // Remove from rfid_to_user
    await remove(ref(db, `rfid_to_user/${rfid}`));

    // Move linked UID back to unlinked if it exists
    const linkedSnap = await get(ref(db, `linked_uids/${rfid}`));
    if (linkedSnap.exists()) {
      const data = linkedSnap.val(); // only points
      await set(ref(db, `unlinked_uids/${rfid}`), data);
      await remove(ref(db, `linked_uids/${rfid}`));
    }

    linkedRFID = null;
    document.getElementById("rfid").textContent = "Not linked";
    document.getElementById("unlinkBtn").style.display = "none";

    alert(`RFID ${rfid} unlinked successfully.`);
  } catch (err) {
    console.error(err);
    alert("Error unlinking RFID: " + err.message);
  }
};

// Logout
window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

// Reset Password
window.resetPassword = () => {
  const user = auth.currentUser;
  if (user?.email) {
    sendPasswordResetEmail(auth, user.email)
      .then(() => alert("Password reset email sent to " + user.email))
      .catch(err => alert("Error: " + err.message));
  }
};

// Mobile nav
window.toggleMobileNav = () => document.getElementById("mobileDropdown").classList.toggle("show");

</script>

</body>
</html>



