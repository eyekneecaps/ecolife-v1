<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Profile – EcoLife</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#0a192a; color:#fff; }
    .topnav { display:flex; justify-content:space-between; align-items:center; padding:1rem; background:#000; }
    .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:white; }
    @media (max-width:600px) {
      .hamburger { display:block; }
      .nav-dropdown { display:none; position:absolute; right:1rem; top:3.5rem; background:#073763; flex-direction:column; padding:1rem; border-radius:6px; z-index:999; }
      .nav-dropdown.show { display:flex; }
      .nav-dropdown a { color:white; margin:.5rem 0; text-decoration:none; }
    }
    .nav-right a { color:#fff; margin-left:1rem; text-decoration:none; }
    .container { max-width:640px; margin:3rem auto; padding:2rem; background:#07121f; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .info-row { margin-bottom:1rem; }
    .info-label { font-weight:700; margin-right:6px; }
    .uid { font-family:ui-monospace, Menlo, Consolas, monospace; color:#00ff99; }
    .btn { display:inline-block; margin:.35rem .25rem; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-size:15px; transition:.2s; }
    .btn:hover { opacity:.85; }
    .btn-back { background:#444; color:white; }
    .btn-logout { background:#e74c3c; color:white; }
    .btn-reset { background:#3498db; color:white; }
    .btn-unlink { background:#f39c12; color:white; display:none; }
    .hint { opacity:.8; font-size:.9rem; }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="nav-left"><strong>EcoLife</strong></div>
    <div class="nav-right">
      <a href="index.html">About</a>
      <a href="products.html">Services</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="leaderboard.html">Leaderboard</a>
    </div>
    <button class="hamburger" onclick="toggleMobileNav()">☰</button>
  </nav>

  <div class="nav-dropdown" id="mobileDropdown">
    <a href="index.html">About</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
  </div>

  <div class="container">
    <h2>Your Profile</h2>

    <div class="info-row">
      <span class="info-label">Name:</span>
      <span id="name">Loading…</span>
    </div>

    <div class="info-row">
      <span class="info-label">Email:</span>
      <span id="email">Loading…</span>
    </div>

    <div class="info-row">
      <span class="info-label">RFID Linked:</span>
      <span id="rfid" class="uid">Checking…</span>
    </div>

    <div class="info-row">
      <span class="info-label">User ID:</span>
      <span id="uid" class="uid">—</span>
    </div>

    <div class="hint">Points shown live from <code>linked_uids/&lt;rfid&gt;/points</code>.</div>

    <div style="margin-top:1rem">
      <button class="btn btn-back" onclick="location.href='dashboard.html'">← Back to Dashboard</button>
      <button class="btn btn-reset" onclick="resetPassword()">Reset Password</button>
      <button id="unlinkBtn" class="btn btn-unlink" onclick="unlinkRFID()">Unlink RFID</button>
      <button class="btn btn-logout" onclick="logout()">Log Out</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, set, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
      authDomain: "ecolife--v1.firebaseapp.com",
      databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ecolife--v1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const nameEl   = document.getElementById("name");
    const emailEl  = document.getElementById("email");
    const uidEl    = document.getElementById("uid");
    const rfidEl   = document.getElementById("rfid");
    const unlinkBt = document.getElementById("unlinkBtn");

    let currentUserId = null;
    let currentRFID   = null;
    let pointsUnsub   = null;

    function toggleMobileNav(){ document.getElementById("mobileDropdown").classList.toggle("show"); }
    window.toggleMobileNav = toggleMobileNav;

    function detachPoints(){
      if (pointsUnsub) { try { pointsUnsub(); } catch(_){} pointsUnsub = null; }
    }

    function watchPoints(rfid){
      detachPoints();
      if (!rfid) return;
      const pRef = ref(db, `linked_uids/${rfid}/points`);
      pointsUnsub = onValue(pRef, (snap)=>{
        const pts = snap.exists() ? snap.val() : 0;
        rfidEl.textContent = `${rfid} (Points: ${pts})`;
      }, (err)=>{
        // Permission issues surface here if rules aren't set
        rfidEl.textContent = `${rfid} (Points: —)`;
        console.warn("points listener error:", err?.message);
      });
    }

    // Efficient RFID lookup via indexed query (requires .indexOn:["uid"])
    async function getRFIDForUser(userId){
      const q = query(ref(db, "rfid_to_user"), orderByChild("uid"), equalTo(userId));
      const snap = await get(q);
      if (!snap.exists()) return null;
      const obj = snap.val();
      return Object.keys(obj)[0] || null;
    }

    // --- Auth + profile load ---
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { location.href = "login.html"; return; }

      currentUserId = user.uid;
      nameEl.textContent  = user.displayName || user.email || "User";
      emailEl.textContent = user.email || "—";
      uidEl.textContent   = user.uid;

      const userRef = ref(db, `users/${user.uid}`);
      onValue(userRef, async (snap)=>{
        const data = snap.val() || {};
        currentRFID = data.rfid || null;

        if (!currentRFID) {
          // Auto-recover from mapping if present
          try {
            const recovered = await getRFIDForUser(currentUserId);
            if (recovered) {
              currentRFID = recovered;
              try { await update(userRef, { rfid: recovered }); } catch(_) {}
              unlinkBt.style.display = "";
              watchPoints(currentRFID);
              return;
            }
          } catch(e){ console.warn(e); }
          rfidEl.textContent = "Not linked";
          unlinkBt.style.display = "none";
          detachPoints();
        } else {
          unlinkBt.style.display = "";
          watchPoints(currentRFID);
        }
      }, (err)=>{
        // If users node is locked down, show minimal info
        console.warn("users listener error:", err?.message);
      });
    });

    // --- Full unlink cleanup helper ---
    async function cleanupUnlinkForUser(userId){
      // 1) read RFID
      const rfidSnap = await get(ref(db, `users/${userId}/rfid`));
      if (!rfidSnap.exists() || !rfidSnap.val()) throw new Error("No RFID linked to this account.");
      const rfid = rfidSnap.val();

      // 2) move linked_uids/<rfid> -> unlinked_uids/<rfid>
      const linkedRef = ref(db, `linked_uids/${rfid}`);
      const linkedSnap = await get(linkedRef);
      if (linkedSnap.exists()) {
        await set(ref(db, `unlinked_uids/${rfid}`), linkedSnap.val());
        await remove(linkedRef);
      }

      // 3) remove rfid_to_user/<rfid>
      await remove(ref(db, `rfid_to_user/${rfid}`));

      // 4) delete users/<uid>/events
      await remove(ref(db, `users/${userId}/events`)).catch(()=>{});

      // 5) clear user fields
      await update(ref(db, `users/${userId}`), {
        rfid: null,
        rfid_uid: null,
        points: 0
      });

      return rfid;
    }

    // Button wrapper
    async function unlinkRFID(){
      try {
        const rfid = await cleanupUnlinkForUser(currentUserId);
        detachPoints();
        currentRFID = null;
        rfidEl.textContent = "Not linked";
        unlinkBt.style.display = "none";
        alert(`RFID ${rfid} unlinked and cleaned.`);
      } catch(e){
        alert("Unlink failed: " + (e?.message || e));
      }
    }
    window.unlinkRFID = unlinkRFID;

    // Small helpers
    window.logout = () => signOut(auth).then(()=> location.href="login.html");
    window.resetPassword = () => {
      const u = auth.currentUser;
      if (u?.email) {
        sendPasswordResetEmail(auth, u.email)
          .then(()=>alert("Password reset email sent to " + u.email))
          .catch(err=>alert("Error: " + (err?.message||err)));
      } else {
        alert("No email for this account.");
      }
    };
  </script>
</body>
</html>
