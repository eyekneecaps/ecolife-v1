<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Profile – EcoLife</title>
  <link rel="icon" href="favicon.png" type="image/png">
<style>
/* ===== HARD OVERRIDES (place FIRST in <head>) ===== */
:root { --eco-bg:#0a192a; --eco-card:#07121f; --eco-blue:#073763; --eco-text:#ffffff; }
* { box-sizing: border-box; }
html, body { margin:0!important; padding:0!important; background:var(--eco-bg)!important; color:var(--eco-text)!important; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif!important; }

/* Topnav — enforced */
.topnav {
  display:flex!important; justify-content:space-between!important; align-items:center!important;
  padding:1rem!important; background:#000!important; color:#fff!important; position:relative!important; z-index:1000!important;
}
.topnav .nav-center { font-size:1.2rem!important; font-weight:700!important; }
.topnav .gear { font-size:1.5rem!important; cursor:pointer!important; color:#fff!important; }
.topnav .nav-links { display:flex!important; gap:1rem!important; align-items:center!important; }
.topnav a, .topnav a:visited { color:#fff!important; text-decoration:none!important; font-weight:500!important; }
.topnav a:hover { text-decoration:underline!important; }
.hamburger { display:none!important; font-size:1.5rem!important; background:none!important; border:none!important; color:#fff!important; }

/* Mobile dropdown */
@media (max-width:600px){
  .hamburger{ display:block!important; }
  .topnav .nav-links{ display:none!important; }
  .nav-dropdown{
    display:none!important; position:absolute!important; right:1rem!important; top:3.5rem!important;
    background:var(--eco-blue)!important; padding:1rem!important; border-radius:6px!important; z-index:1001!important;
  }
  .nav-dropdown.show{ display:flex!important; flex-direction:column!important; }
  .nav-dropdown a{ color:#fff!important; margin:.5rem 0!important; text-decoration:none!important; }
}

/* Cards / layout */
.container{
  max-width:640px!important; margin:3rem auto!important; padding:1.5rem!important;
  background:var(--eco-card)!important; border-radius:12px!important; box-shadow:0 4px 12px rgba(0,0,0,.45)!important;
}
.info-row{ margin-bottom:1rem!important; }
.info-label{ font-weight:700!important; margin-right:6px!important; }
.uid{ font-family:ui-monospace, Menlo, Consolas, monospace!important; color:#00ff99!important; }

/* Buttons */
.btn{ display:inline-block!important; margin:.35rem .25rem!important; padding:10px 14px!important;
  border:none!important; border-radius:8px!important; cursor:pointer!important; font-size:15px!important; transition:.2s!important; }
.btn:hover{ opacity:.92!important; }
.btn-back{ background:#444!important; color:#fff!important; }
.btn-reset{ background:#3498db!important; color:#fff!important; }
.btn-unlink{ background:#f39c12!important; color:#fff!important; display:none!important; } /* JS toggles */
.btn-logout{ background:#e74c3c!important; color:#fff!important; }

.hint{ opacity:.8!important; font-size:.9rem!important; }
.status{ margin-top:.75rem!important; font-size:.95rem!important; }
.status.error{ color:#ff6b6b!important; }
</style>

</head>
<body>
  <!-- Header -->
  <nav class="topnav">
    <div class="nav-left">
      <span class="gear" onclick="location.href='profile.html'">⚙️</span>
    </div>
    <div class="nav-center"><strong>EcoLife</strong></div>
    <div class="nav-right nav-links">
      <a href="index.html">About</a>
      <a href="products.html">Services</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="signup.html" id="signupLink">Sign Up</a>
      <a href="login.html" id="loginLink">Login</a>
    </div>
    <button class="hamburger" onclick="document.getElementById('mobileDropdown').classList.toggle('show')">☰</button>
  </nav>

  <div class="nav-dropdown" id="mobileDropdown">
    <a href="index.html">About</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLinkMobile">Sign Up</a>
    <a href="login.html" id="loginLinkMobile">Login</a>
  </div>

  <!-- Profile card -->
  <div class="container">
    <h2>Your Profile</h2>

    <div class="info-row"><span class="info-label">Name:</span> <span id="name">Loading…</span></div>
    <div class="info-row"><span class="info-label">Email:</span> <span id="email">Loading…</span></div>
    <div class="info-row"><span class="info-label">RFID Linked:</span> <span id="rfid" class="uid">Checking…</span></div>
    <div class="info-row"><span class="info-label">User ID:</span> <span id="uid" class="uid">—</span></div>

    <div class="hint">Points shown live from <code>linked_uids/&lt;rfid&gt;/points</code>.</div>
    <div id="statusLine" class="status"></div>

    <div style="margin-top:1rem">
      <button class="btn btn-back" onclick="location.href='dashboard.html'">← Back to Dashboard</button>
      <button class="btn btn-reset" onclick="resetPassword()">Reset Password</button>
      <button id="unlinkBtn" class="btn btn-unlink" onclick="unlinkRFID()">Unlink RFID</button>
      <button class="btn btn-logout" onclick="logout()">Log Out</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, set, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
      authDomain: "ecolife--v1.firebaseapp.com",
      databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ecolife--v1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const nameEl    = document.getElementById("name");
    const emailEl   = document.getElementById("email");
    const uidEl     = document.getElementById("uid");
    const rfidEl    = document.getElementById("rfid");
    const unlinkBtn = document.getElementById("unlinkBtn");
    const statusEl  = document.getElementById("statusLine");

    const setStatus = (msg, type="")=>{
      statusEl.textContent = msg||"";
      statusEl.className = type ? `status ${type}` : "status";
    };

    // --- Points listener ---
    let pointsUnsub = null;
    function detachPoints(){ if(pointsUnsub){ try{ pointsUnsub(); }catch{} pointsUnsub=null; } }
    function watchPoints(rfid){
      detachPoints();
      if(!rfid) return;
      const pRef = ref(db, `linked_uids/${rfid}/points`);
      pointsUnsub = onValue(pRef, (snap)=>{
        const pts = snap.exists()? snap.val(): 0;
        rfidEl.textContent = `${rfid} (Points: ${pts})`;
      }, ()=>{
        rfidEl.textContent = `${rfid} (Points: —)`;
      });
    }

    // --- RFID lookup (indexed query) ---
    async function getRFIDForUser(userId){
      const q = query(ref(db, "rfid_to_user"), orderByChild("uid"), equalTo(userId));
      const snap = await get(q);
      if (!snap.exists()) return null;
      const obj = snap.val();
      return Object.keys(obj)[0] || null;
    }

    // --- Unlink cleanup ---
    async function cleanupUnlinkForUser(userId){
      const rfidSnap = await get(ref(db, `users/${userId}/rfid`));
      if (!rfidSnap.exists() || !rfidSnap.val()) throw new Error("No RFID linked to this account.");
      const rfid = rfidSnap.val();

      const linkedRef = ref(db, `linked_uids/${rfid}`);
      const linkedSnap = await get(linkedRef);
      if (linkedSnap.exists()){
        await set(ref(db, `unlinked_uids/${rfid}`), linkedSnap.val());
        await remove(linkedRef);
      }

      await remove(ref(db, `rfid_to_user/${rfid}`));
      await remove(ref(db, `users/${userId}/events`)).catch(()=>{});
      await update(ref(db, `users/${userId}`), { rfid:null, rfid_uid:null, points:0 });

      return rfid;
    }

    async function unlinkRFID(){
      setStatus("");
      try{
        const user = auth.currentUser;
        if(!user) { setStatus("Not logged in.", "error"); return; }
        await cleanupUnlinkForUser(user.uid);

        // Quiet UI updates (no popup)
        detachPoints();
        rfidEl.textContent = "Not linked";
        unlinkBtn.style.display = "none";
      }catch(e){
        setStatus("Unlink failed: " + (e?.message || e), "error");
      }
    }
    window.unlinkRFID = unlinkRFID;

    // --- Auth + profile load ---
    onAuthStateChanged(auth, async (user)=>{
      const loggedIn = !!user;

      // header auth links (match dashboard)
      const show = (id, on)=>{ const el=document.getElementById(id); if(el) el.style.display = on? "": "none"; };
      show("signupLink", !loggedIn);
      show("loginLink",  !loggedIn);
      show("signupLinkMobile", !loggedIn);
      show("loginLinkMobile",  !loggedIn);

      if (!user){ location.href = "login.html"; return; }

      nameEl.textContent  = user.displayName || user.email || "User";
      emailEl.textContent = user.email || "—";
      uidEl.textContent   = user.uid;

      const userRef = ref(db, `users/${user.uid}`);
      onValue(userRef, async (snap)=>{
        const data = snap.val() || {};
        let rfid = data.rfid || null;

        if (!rfid){
          try {
            const recovered = await getRFIDForUser(user.uid);
            if (recovered){
              rfid = recovered;
              try { await update(userRef, { rfid: recovered }); } catch(_) {}
            }
          } catch {}
        }

        if (rfid){
          unlinkBtn.style.display = "inline-block";
          watchPoints(rfid);
          setStatus("");
        } else {
          unlinkBtn.style.display = "none";
          detachPoints();
          rfidEl.textContent = "Not linked";
        }
      });
    });

    // --- Account helpers ---
    window.logout = () => signOut(auth).then(()=> location.href="login.html");
    window.resetPassword = () => {
      const u = auth.currentUser;
      if (u?.email) {
        sendPasswordResetEmail(auth, u.email)
          .then(()=>{/* quiet */})
          .catch(err=>setStatus("Reset error: " + (err?.message||err), "error"));
      } else {
        setStatus("No email for this account.", "error");
      }
    };
  </script>
</body>
</html>

