<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äì EcoLife</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#0a192a; color:white; font-family: system-ui, sans-serif; margin:0; padding:0; }

    /* Shared header (matches leaderboard/profile) */
    .topnav{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#000;color:#fff}
    .nav-center{font-size:1.2rem;font-weight:700}
    .gear{font-size:1.5rem;cursor:pointer;color:#fff}
    .nav-links{display:flex;gap:1rem;align-items:center}
    .topnav a,.topnav a:visited{color:#fff!important;text-decoration:none}
    .topnav a:hover{text-decoration:underline}
    .hamburger{display:none;font-size:1.5rem;background:none;border:none;color:#fff}
    @media(max-width:600px){
      .hamburger{display:block}
      .nav-links{display:none}
      .nav-dropdown{display:none;position:absolute;right:1rem;top:3.5rem;background:#073763;flex-direction:column;padding:1rem;border-radius:6px;z-index:999}
      .nav-dropdown.show{display:flex}
      .nav-dropdown a{color:white;margin:0.5rem 0;text-decoration:none}
    }

    .auth-box{max-width:1000px;margin:2.5rem auto;padding:1.5rem;}
    .card{background:#07121f;padding:1.25rem;border-radius:10px;margin-bottom:1rem;box-shadow:0 4px 10px rgba(0,0,0,0.45);}
    .card h2,.card h3{margin-top:0;}
    .rfid-card{background:#111;padding:1.5rem;border-radius:10px;margin-top:1rem;}
    #rfidInput,#modalRfidInput{width:100%;padding:0.7rem;margin-top:0.5rem;border-radius:8px;border:1px solid #333;background:#222;color:white;}
    .rfid-link-btn{padding:0.6rem 1rem;background:#073763;color:white;border:none;border-radius:6px;cursor:pointer;margin-left:0.5rem;}
    .rfid-link-btn:hover{filter: brightness(1.05);}
    #rfidMessage,#modalRfidMessage{margin-top:0.8rem;font-size:0.95rem;}
    table{width:100%;border-collapse:collapse;color:white;margin-top:1rem;}
    table th,table td{text-align:left;padding:0.6rem 0.75rem;border-bottom:1px solid rgba(255,255,255,0.04);}
    table th{font-weight:600;color:#cfd8dc;}
    .inline{display:inline-block;vertical-align:middle;}
    .success{color:#84cc16;}
    .error{color:#ff6b6b;}
  </style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav">
  <div class="nav-left"><span class="gear" onclick="location.href='profile.html'">‚öôÔ∏è</span></div>
  <div class="nav-center"><strong>EcoLife</strong></div>
  <div class="nav-right nav-links">
    <a href="index.html">About</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLink">Sign Up</a>
    <a href="login.html"  id="loginLink">Login</a>
  </div>
  <button class="hamburger" onclick="document.getElementById('mobileDropdown').classList.toggle('show')">‚ò∞</button>
</nav>

<!-- MOBILE DROPDOWN -->
<div class="nav-dropdown" id="mobileDropdown">
  <a href="index.html">About</a>
  <a href="products.html">Services</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="signup.html" id="signupLinkMobile">Sign Up</a>
  <a href="login.html"  id="loginLinkMobile">Login</a>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" style="display:none;position:fixed;top:4rem;left:1rem;background:#111;padding:1rem;border-radius:8px;z-index:1001;">
  <div id="linkRFIDOption" style="margin-bottom:1rem;">
    <button onclick="openRFIDModal()">üîó Link RFID</button>
  </div>
  <button style="color:red;background:none;border:none;text-decoration:underline;margin-top:1rem;cursor:pointer;" onclick="logout()">Log Out</button>
</div>

<!-- Main Content -->
<div class="auth-box">
  <div class="card">
    <h2>Welcome to your Dashboard</h2>
    <p>This is your control panel to track your recycling points and linked RFID cards.</p>
    <div style="display:flex; gap:1.5rem; flex-wrap:wrap; margin-top:1rem;">
      <div><strong>Name:</strong> <span id="userName">Loading...</span></div>
      <div><strong>User ID:</strong> <span id="userId">---</span></div>
      <div><strong>Linked RFID:</strong> <span id="linkedRFID">---</span></div>
      <div><strong>Your Points:</strong> <span id="userPoints">0</span></div>
    </div>
  </div>

  <!-- RFID Card -->
  <div id="rfidSection" class="rfid-card card" style="display:none;">
    <h3>üîó Link Your RFID Card</h3>
    <p>Enter the UID printed on your EcoCard.</p>
    <input id="rfidInput" placeholder="Enter RFID UID (e.g., 123456789)" />
    <button class="rfid-link-btn" id="linkButton">Link UID</button>
    <div id="rfidMessage"></div>
  </div>

  <!-- Dashboard Table -->
  <div class="card">
    <h3>Your Linked Card</h3>
    <table id="dashboardTable">
      <tr><th>UID</th><th>Points</th></tr>
    </table>
  </div>
</div>

<!-- RFID Modal -->
<div id="rfidModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1002;">
  <div style="background:#1c1c1c;padding:1.5rem;border-radius:10px;max-width:480px;width:90%;">
    <div style="display:flex;justify-content:flex-end;">
      <button onclick="closeRFIDModal()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;">‚úï</button>
    </div>
    <h3>Enter RFID UID</h3>
    <input id="modalRfidInput" placeholder="Enter RFID UID" />
    <div style="margin-top:0.75rem;">
      <button class="rfid-link-btn" id="modalLinkBtn">Link</button>
      <button class="rfid-link-btn" onclick="closeRFIDModal()" style="margin-left:0.5rem;">Cancel</button>
    </div>
    <div id="modalRfidMessage"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, get, set, update, remove, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
  authDomain: "ecolife--v1.firebaseapp.com",
  databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ecolife--v1"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const auth = getAuth(app);

// DOM
const userNameEl = document.getElementById("userName");
const userIdEl = document.getElementById("userId");
const linkedRFIDEl = document.getElementById("linkedRFID");
const userPointsEl = document.getElementById("userPoints");
const rfidSection = document.getElementById("rfidSection");
const rfidInput = document.getElementById("rfidInput");
const linkButton = document.getElementById("linkButton");
const rfidMessage = document.getElementById("rfidMessage");
const dashboardTable = document.getElementById("dashboardTable");
const modal = document.getElementById("rfidModal");
const modalInput = document.getElementById("modalRfidInput");
const modalLinkBtn = document.getElementById("modalLinkBtn");
const modalMessage = document.getElementById("modalRfidMessage");

let currentUser = null;
let currentUserRFID = null;
let unsubscribePoints = null;

function showMessage(el, text, type="error"){ el.textContent = text; el.className = type === "success" ? "success" : "error"; }
function clearMessage(el){ el.textContent = ""; el.className = ""; }
function updateDashboardTable(rfid, points){
  dashboardTable.innerHTML = `<tr><th>UID</th><th>Points</th></tr>`;
  const tr = document.createElement("tr");
  tr.innerHTML = rfid ? `<td>${rfid}</td><td>${points||0}</td>` : `<td colspan="2">No RFID linked</td>`;
  dashboardTable.appendChild(tr);
}

// Auth
onAuthStateChanged(auth, (user) => {
  if (!user) { window.location.href = "login.html"; return; }
  currentUser = user;
  userNameEl.textContent = user.displayName || user.email || "User";
  userIdEl.textContent = user.uid;

  const userRef = ref(db, `users/${user.uid}`);
  onValue(userRef, (snap) => {
    const data = snap.val() || {};
    // prefer 'rfid' (new), fallback to 'rfid_uid' (legacy)
    currentUserRFID = data.rfid || data.rfid_uid || null;
    linkedRFIDEl.textContent = currentUserRFID || "Not linked";

    if (unsubscribePoints) { try{unsubscribePoints();}catch{} unsubscribePoints = null; }

    if (!currentUserRFID) {
      rfidSection.style.display = "block";
      userPointsEl.textContent = Number(data.points || 0);
      updateDashboardTable(null, null);
    } else {
      rfidSection.style.display = "none";
      const ptsRef = ref(db, `linked_uids/${currentUserRFID}/points`);
      unsubscribePoints = onValue(ptsRef, (ptsSnap) => {
        const pts = ptsSnap.exists() ? ptsSnap.val() : 0;
        userPointsEl.textContent = pts;
        updateDashboardTable(currentUserRFID, pts);
      });
    }
  });
});

/**
 * Robust link (transaction):
 * - Claims rfid_to_user/<rfid> if empty or already mine.
 * - Converts legacy string rows to { uid } if they belong to me.
 * - Seeds linked_uids/<rfid>/points from unlinked pool.
 * - Writes users/<uid>/rfid (and rfid_uid for backward compat).
 */
async function linkRFID(uidValue, inputEl, messageEl, buttonEl){
  clearMessage(messageEl);
  uidValue = (uidValue||"").trim().toUpperCase();
  if (!uidValue) { showMessage(messageEl, "Enter a valid UID."); return; }
  if (!currentUser) { showMessage(messageEl, "Not logged in."); return; }
  if (currentUserRFID) { showMessage(messageEl, "You already have a linked RFID."); return; }

  try {
    // read unlinked points (support both keys just in case)
    let points = 0;
    let unlinkedRef = ref(db, `unlinked_uids/${uidValue}`);
    let snap = await get(unlinkedRef);
    if (!snap.exists()) {
      const alt = ref(db, `_unlinked_uids/${uidValue}`);
      const altSnap = await get(alt);
      if (altSnap.exists()) { unlinkedRef = alt; snap = altSnap; }
    }
    if (snap?.exists()) points = Number(snap.val()?.points || 0);

    // transactional claim of rfid_to_user
    const mapRef = ref(db, `rfid_to_user/${uidValue}`);
    const txn = await runTransaction(mapRef, (current) => {
      if (current === null) return { uid: currentUser.uid };                 // claim
      if (typeof current === "string") {
        if (current === currentUser.uid) return { uid: currentUser.uid };    // convert my legacy string
        return;                                                               // someone else ‚Üí abort
      }
      if (current && typeof current === "object" && current.uid === currentUser.uid) {
        return current;                                                       // idempotent
      }
      return;                                                                 // someone else ‚Üí abort
    }, { applyLocally:false });

    if (!txn.committed) {
      showMessage(messageEl, "This UID is already linked to another account.");
      return;
    }

    // seed linked points + write user fields
    await Promise.all([
      set(ref(db, `linked_uids/${uidValue}/points`), points),
      update(ref(db, `users/${currentUser.uid}`), { rfid: uidValue, rfid_uid: uidValue, points })
    ]);

    // remove from unlinked pool (best effort)
    try { await remove(unlinkedRef); } catch {}

    // UI
    currentUserRFID = uidValue;
    linkedRFIDEl.textContent = uidValue;
    userPointsEl.textContent = points;
    updateDashboardTable(uidValue, points);
    if (inputEl) inputEl.disabled = true;
    if (buttonEl) buttonEl.style.display = "none";
    showMessage(messageEl, `RFID ${uidValue} linked successfully.`, "success");
    closeRFIDModal();

  } catch (err) {
    console.error("Link error:", err);
    showMessage(messageEl, `Error: ${err?.message || err}`, "error");
  }
}

// Buttons
document.getElementById("linkButton").addEventListener("click", () => linkRFID(rfidInput.value, rfidInput, rfidMessage, linkButton));
document.getElementById("modalLinkBtn").addEventListener("click", () => linkRFID(modalInput.value, modalInput, modalMessage, modalLinkBtn));

// Modal helpers
function openRFIDModal(){ modal.style.display = "flex"; modalInput.value=""; clearMessage(modalMessage); }
function closeRFIDModal(){ modal.style.display = "none"; }
window.openRFIDModal = openRFIDModal;

// Misc
window.logout = () => signOut(auth).then(()=>window.location.href="login.html");
document.querySelector(".gear").addEventListener("click", ()=>{
  const panel = document.getElementById("settingsPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
});
window.checkLogin = (e)=>{ if (!currentUser) { e.preventDefault(); alert("You must be logged in to access the dashboard."); } };
</script>

<!-- Chatbot -->
<script>
  window._ow = window._ow || {};
  window.__ow = window.__ow || {};
  window.__ow.organizationId = "d8d1b35d-3974-4620-802f-b6383b2e7a1c";
  window.__ow.template_id = "7d4a29cb-ee55-4528-803a-d58f9fe8d3fc";
  window.__ow.integration_name = "manual_settings";
  window.__ow.product_name = "chatbot";
  (function(n,t,c){function i(n){return e.h?e._h.apply(null,n):e._q.push(n)}
    var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[OpenWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0;n.type="text/javascript";n.src="https://cdn.openwidget.com/openwidget.js";t.head.appendChild(n)}};!n._ow.asyncInit&&e.init();n.OpenWidget=n.OpenWidget||e})(window,document,[].slice)
</script>

</body>
</html>
