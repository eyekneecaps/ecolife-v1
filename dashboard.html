<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard ‚Äì EcoLife</title>
<link rel="stylesheet" href="style.css" />
<style>
  body { background:#0a192a; color:white; font-family: system-ui, sans-serif; margin:0; padding:0; }
  .topnav { display:flex; justify-content:space-between; align-items:center; padding:1rem; background-color:#000; }
  .gear { font-size:1.5rem; cursor:pointer; color:white; }
  .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:white; }
  @media(max-width:600px){.hamburger{display:block}.nav-dropdown{display:none;position:absolute;right:1rem;top:3.5rem;background:#073763;flex-direction:column;padding:1rem;border-radius:6px;z-index:999}.nav-dropdown.show{display:flex}.nav-dropdown a{color:white;margin:0.5rem 0;text-decoration:none}}
  .auth-box{max-width:1000px;margin:2.5rem auto;padding:1.5rem;}
  .card{background:#07121f;padding:1.25rem;border-radius:10px;margin-bottom:1rem;box-shadow:0 4px 10px rgba(0,0,0,0.45);}
  .card h2, .card h3{margin-top:0;}
  .rfid-card{background:#111;padding:1.5rem;border-radius:10px;margin-top:1rem;}
  #rfidInput, #modalRfidInput{width:100%;padding:0.7rem;margin-top:0.5rem;border-radius:8px;border:1px solid #333;background:#222;color:white;}
  .rfid-link-btn{padding:0.6rem 1rem;background:#073763;color:white;border:none;border-radius:6px;cursor:pointer;margin-left:0.5rem;}
  .rfid-link-btn:hover{filter: brightness(1.05);}
  #rfidMessage, #modalRfidMessage{margin-top:0.8rem;font-size:0.95rem;}
  table{width:100%;border-collapse:collapse;color:white;margin-top:1rem;}
  table th, table td{text-align:left;padding:0.6rem 0.75rem;border-bottom:1px solid rgba(255,255,255,0.04);}
  table th{font-weight:600;color:#cfd8dc;}
  .inline{display:inline-block;vertical-align:middle;}
  .success{color:#84cc16;}
  .error{color:#ff6b6b;}
</style>
</head>
<body>

<!-- TOP NAVIGATION -->
<nav class="topnav">
  <div class="nav-left">
    <span class="gear" onclick="window.location.href='profile.html'">‚öôÔ∏è</span>
  </div>
  <div class="nav-center"><strong>EcoLife</strong></div>
  <div class="nav-right desktop-links">
    <a href="index.html">About Us</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
  </div>
  <button class="hamburger" onclick="toggleMobileNav()">‚ò∞</button>
</nav>

<!-- MOBILE DROPDOWN -->
<div class="nav-dropdown" id="mobileDropdown">
  <a href="index.html">About Us</a>
  <a href="products.html">Services</a>
  <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
  <a href="leaderboard.html">Leaderboard</a>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" style="display:none;position:fixed;top:4rem;left:1rem;background:#111;padding:1rem;border-radius:8px;z-index:1001;">
  <div id="linkRFIDOption" style="margin-bottom:1rem;">
    <button onclick="openRFIDModal()">üîó Link RFID</button>
  </div>
  <button style="color:red;background:none;border:none;text-decoration:underline;margin-top:1rem;cursor:pointer;" onclick="logout()">Log Out</button>
</div>

<!-- Main Content -->
<div class="auth-box">
  <div class="card">
    <h2>Welcome to your Dashboard</h2>
    <p>This is your control panel to track your recycling points and linked RFID cards.</p>
    <div style="display:flex; gap:1.5rem; flex-wrap:wrap; margin-top:1rem;">
      <div><strong>Name:</strong> <span id="userName">Loading...</span></div>
      <div><strong>User ID:</strong> <span id="userId">---</span></div>
      <div><strong>Linked RFID:</strong> <span id="linkedRFID">---</span></div>
      <div><strong>Your Points:</strong> <span id="userPoints">0</span></div>
    </div>
  </div>

  <!-- RFID Card -->
  <div id="rfidSection" class="rfid-card card" style="display:none;">
    <h3>üîó Link Your RFID Card</h3>
    <p>Enter the UID printed on your EcoCard.</p>
    <input id="rfidInput" placeholder="Enter RFID UID (e.g., 123456789)" />
    <button class="rfid-link-btn" id="linkButton">Link UID</button>
    <div id="rfidMessage"></div>
  </div>

  <!-- Dashboard Table -->
  <div class="card">
    <h3>Your Linked Card</h3>
    <table id="dashboardTable">
      <tr><th>UID</th><th>Points</th></tr>
    </table>
  </div>
</div>

<!-- RFID Modal -->
<div id="rfidModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1002;">
  <div style="background:#1c1c1c;padding:1.5rem;border-radius:10px;max-width:480px;width:90%;">
    <div style="display:flex;justify-content:flex-end;">
      <button onclick="closeRFIDModal()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;">‚úï</button>
    </div>
    <h3>Enter RFID UID</h3>
    <input id="modalRfidInput" placeholder="Enter RFID UID" />
    <div style="margin-top:0.75rem;">
      <button class="rfid-link-btn" id="modalLinkBtn">Link</button>
      <button class="rfid-link-btn" onclick="closeRFIDModal()" style="margin-left:0.5rem;">Cancel</button>
    </div>
    <div id="modalRfidMessage"></div>
  </div>
</div>

<script type="module">
import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getDatabase, ref, get, update, remove, onValue 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { app } from "./firebase-config.js"; // your firebase init

// Firebase
const auth = getAuth(app);
const db = getDatabase(app);

// Elements
const userNameEl = document.getElementById("userName");
const userIdEl = document.getElementById("userId");
const linkedRFIDEl = document.getElementById("linkedRFID");
const userPointsEl = document.getElementById("userPoints");
const rfidSection = document.getElementById("rfidSection");
const linkBtn = document.getElementById("linkButton");
const modalLinkBtn = document.getElementById("modalLinkBtn");

let currentUser = null;
let currentUserRFID = null;

// =======================
// Auth state listener
// =======================
onAuthStateChanged(auth, async (user) => {
  if (!user) { 
    window.location.href = "login.html"; 
    return; 
  }
  currentUser = user;

  // Display name + UID
  userNameEl.textContent = user.displayName || "User";
  userIdEl.textContent = user.uid;

  // Listen for user data
  const userRef = ref(db, `users/${user.uid}`);
  onValue(userRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();

    currentUserRFID = data?.rfid || null;
    linkedRFIDEl.textContent = currentUserRFID || "Not linked";

    if (!currentUserRFID) {
      rfidSection.style.display = "block";
      userPointsEl.textContent = "0";
      updateDashboardTable(null);
    } else {
      rfidSection.style.display = "none";

      // Always get points from RFID path
      const rfidPointsRef = ref(db, `rfid_to_user/${currentUserRFID}/points`);
      onValue(rfidPointsRef, (rfidSnap) => {
        if (rfidSnap.exists()) {
          const points = rfidSnap.val();
          userPointsEl.textContent = points;
          updateDashboardTable({ rfid: currentUserRFID, points });
        } else {
          userPointsEl.textContent = "0";
          updateDashboardTable({ rfid: currentUserRFID, points: 0 });
        }
      });
    }
  });
});

// =======================
// RFID Linking (input + modal)
// =======================
async function linkRFID(uid) {
  if (!uid) return;

  const unlinkedRef = ref(db, `unlinked_uids/${uid}`);
  const snap = await get(unlinkedRef);
  if (!snap.exists()) {
    alert("Invalid or already linked UID.");
    return;
  }

  try {
    await update(ref(db), {
      [`users/${currentUser.uid}/rfid`]: uid,
      [`rfid_to_user/${uid}/uid`]: currentUser.uid,
    });
    await remove(unlinkedRef);
    alert("RFID linked successfully!");
  } catch (err) {
    console.error(err);
    alert("Failed to link RFID.");
  }
}

linkBtn.addEventListener("click", () => {
  const val = document.getElementById("rfidInput").value.trim();
  linkRFID(val);
});

modalLinkBtn.addEventListener("click", () => {
  const val = document.getElementById("modalRfidInput").value.trim();
  linkRFID(val);
});

// =======================
// Logout
// =======================
window.logout = async function () {
  await signOut(auth);
  window.location.href = "login.html";
};

// =======================
// Dashboard Table Update
// =======================
function updateDashboardTable(entry) {
  const table = document.getElementById("dashboardTable");
  table.innerHTML = `<tr><th>UID</th><th>Points</th></tr>`;
  if (entry) {
    table.innerHTML += `<tr><td>${entry.rfid}</td><td>${entry.points}</td></tr>`;
  }
}
</script>

</body>
</html>
