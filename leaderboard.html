<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard ‚Äì EcoLife</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Topnav and other layout stays exactly like About Us page */

    /* Leaderboard styling */
    ul#leaderboardList {
      list-style: none;      /* remove bullets/periods */
      padding-left: 0;       /* remove default padding */
      margin: 0;             /* remove default margin */
      font-size: 1.1rem;
    }

    ul#leaderboardList li {
      margin: 0.5rem 0;
      padding: 0.75rem 1rem;
      background: #1d3b5c;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .rank { font-weight: bold; color: #84cc16; margin-right: 0.5rem; }
    span.points { font-weight: bold; color: #00ff99; }
  </style>
</head>
<body>

<!-- TOP NAVIGATION (same as About Us page) -->
<nav class="topnav">
  <div class="nav-left">
    <span class="gear" onclick="window.location.href='profile.html'">‚öôÔ∏è</span>
  </div>
  <div class="nav-center">EcoLife</div>
  <div class="nav-right desktop-links">
    <a href="index.html">About Us</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLink">Sign Up</a>
    <a href="login.html" id="loginLink">Login</a>
  </div>
  <button class="hamburger" onclick="toggleMobileNav()">‚ò∞</button>
</nav>

<!-- MOBILE DROPDOWN -->
<div class="nav-dropdown" id="mobileDropdown">
  <a href="index.html">About Us</a>
  <a href="products.html">Services</a>
  <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="signup.html" id="signupLinkMobile">Sign Up</a>
  <a href="login.html" id="loginLinkMobile">Login</a>
</div>

<!-- Login Popup -->
<div id="popupMessage">
  You must be logged in to view the dashboard.
  <span class="close-btn" onclick="this.parentElement.style.display='none'">‚úï</span>
</div>

<!-- Leaderboard Content -->
<div class="auth-box" style="max-width: 800px; text-align: center;">
  <h1 style="margin-bottom: 1rem;">üèÜ Leaderboard</h1>
  <ul id="leaderboardList">
    <li>Loading leaderboard...</li>
  </ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
  authDomain: "ecolife--v1.firebaseapp.com",
  databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ecolife--v1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const leaderboardList = document.getElementById("leaderboardList");

// Update login links
onAuthStateChanged(auth, user => {
  const isLoggedIn = !!user;
  document.cookie = `loggedIn=${isLoggedIn}; path=/`;
  document.getElementById("signupLink").style.display = isLoggedIn ? "none" : "inline";
  document.getElementById("loginLink").style.display = isLoggedIn ? "none" : "inline";
  document.getElementById("signupLinkMobile").style.display = isLoggedIn ? "none" : "block";
  document.getElementById("loginLinkMobile").style.display = isLoggedIn ? "none" : "block";
});
//LEADERBOARD
async function fetchLeaderboard() {
  try {
    const rfidSnapshot = await get(ref(db, "rfid_to_user"));
    const rfidUsers = rfidSnapshot.val() || {};
    leaderboardList.innerHTML = "";

    const leaderboardData = [];

    // For each linked RFID, fetch user info
    for (const rfid in rfidUsers) {
      const uid = rfidUsers[rfid];
      const userSnapshot = await get(ref(db, `users/${uid}`));
      const user = userSnapshot.val();
      if (user) {
        leaderboardData.push({
          name: user.name || user.email || "User",
          points: user.points || 0
        });
      }
    }

    // Sort by points descending
    leaderboardData.sort((a,b) => b.points - a.points);

    if (leaderboardData.length === 0) {
      leaderboardList.innerHTML = "<li>No users yet.</li>";
      return;
    }

    // Display leaderboard
    leaderboardData.forEach((user, index) => {
      const trophy = index === 0 ? " ü•á" : index === 1 ? " ü•à" : index === 2 ? " ü•â" : "";
      const li = document.createElement("li");
      li.innerHTML = `<div><span class="rank">${index+1}</span>${user.name}${trophy}</div><span class="points">${user.points} pts</span>`;
      leaderboardList.appendChild(li);
    });

  } catch(err) {
    console.error("Error fetching leaderboard:", err);
    leaderboardList.innerHTML = "<li>Must be logged in to view leaderboard.</li>";
  }
}


// Initial fetch and auto-update every 6 seconds
fetchLeaderboard();
setInterval(fetchLeaderboard, 6000);

// Helpers
window.logout = () => signOut(auth).then(()=>{ document.cookie="loggedIn=false; path=/"; window.location.href="login.html"; });
window.toggleMobileNav = () => document.getElementById("mobileDropdown").classList.toggle("show");
function checkLogin(event){
  const isLoggedIn = document.cookie.includes("loggedIn=true");
  if(!isLoggedIn){
    event.preventDefault();
    const popup = document.getElementById("popupMessage");
    popup.style.display="block";
    setTimeout(()=>popup.style.display="none",4000);
  }
}
</script>

</body>
</html>

