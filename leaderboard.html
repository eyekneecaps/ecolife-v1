<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard ‚Äì EcoLife</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#0a192a; color:white; font-family:system-ui,sans-serif; margin:0; }
    .topnav { display:flex; justify-content:space-between; align-items:center; padding:1rem; background:#000; color:white; }
    .nav-center { font-size:1.2rem; font-weight:700; }
    .nav-links a { color:white; text-decoration:none; margin-left:1rem; }
    .nav-links a:hover { text-decoration:underline; }
    .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:white; }
    @media (max-width:600px){
      .hamburger { display:block; }
      .nav-links { display:none; }
      .nav-dropdown { display:none; position:absolute; right:1rem; top:3.5rem; background:#073763; flex-direction:column; padding:1rem; border-radius:6px; z-index:999; }
      .nav-dropdown.show { display:flex; }
      .nav-dropdown a { color:white; margin:.5rem 0; text-decoration:none; }
    }
    .card { max-width:800px; margin:2rem auto; background:#07121f; padding:1.25rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    ul#board { list-style:none; padding-left:0; }
    ul#board li { display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; border-radius:8px; background:#10223a; margin:.5rem 0; }
    .rank{ font-weight:700; color:#84cc16; margin-right:.75rem }
    .name{ font-weight:600 }
    .points{ opacity:.9 }
    #popupMessage { position:fixed; top:1rem; left:50%; transform:translateX(-50%); background:#ff4444; color:white; padding:.75rem 1.5rem; border-radius:5px; display:none; z-index:1002; }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="nav-left">
      <span class="gear" onclick="location.href='profile.html'">‚öôÔ∏è</span>
    </div>
    <div class="nav-center">EcoLife</div>
    <div class="nav-right nav-links">
      <a href="index.html">About</a>
      <a href="products.html">Services</a>
      <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="signup.html" id="signupLink">Sign Up</a>
      <a href="login.html"  id="loginLink">Login</a>
    </div>
    <button class="hamburger" onclick="toggleMobileNav()">‚ò∞</button>
  </nav>

  <div class="nav-dropdown" id="mobileDropdown">
    <a href="index.html">About</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLinkMobile">Sign Up</a>
    <a href="login.html"  id="loginLinkMobile">Login</a>
  </div>

  <div id="popupMessage">You must be logged in to view the dashboard. <span class="close-btn" onclick="this.parentElement.style.display='none'">‚úï</span></div>

  <div class="card">
    <h2>üèÜ Leaderboard</h2>
    <ul id="board"><li>Loading‚Ä¶</li></ul>
  </div>

  <!-- Chatbot kept as requested -->
  <script>
    window._ow = window._ow || {};
    window.__ow = window.__ow || {};
    window.__ow.organizationId = "d8d1b35d-3974-4620-802f-b6383b2e7a1c";
    window.__ow.template_id     = "7d4a29cb-ee55-4528-803a-d58f9fe8d3fc";
    window.__ow.integration_name = "manual_settings";
    window.__ow.product_name     = "chatbot";
    (function(n, t, c) {
      function i(n) { return e.h ? e._h.apply(null, n) : e._q.push(n); }
      var e = { _q:[], _h:null, _v:"2.0",
        on:function(){ i(["on", c.call(arguments)]) },
        once:function(){ i(["once", c.call(arguments)]) },
        off:function(){ i(["off", c.call(arguments)]) },
        get:function(){ if(!e._h) throw new Error("[OpenWidget] You can't use getters before load."); return i(["get", c.call(arguments)]) },
        call:function(){ i(["call", c.call(arguments)]) },
        init:function(){ var n=t.createElement("script"); n.async=!0; n.type="text/javascript"; n.src="https://cdn.openwidget.com/openwidget.js"; t.head.appendChild(n); }
      };
      !n._ow.asyncInit && e.init(); n.OpenWidget = n.OpenWidget || e;
    }(window, document, [].slice))
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
      authDomain: "ecolife--v1.firebaseapp.com",
      databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ecolife--v1"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const boardEl = document.getElementById("board");

    // auth-driven nav
    onAuthStateChanged(auth, user=>{
      const isLoggedIn = !!user;
      document.cookie = `loggedIn=${isLoggedIn}; path=/`;
      const show = (id, on)=>{ const el=document.getElementById(id); if(el) el.style.display = on? "": "none"; };
      show("signupLink", !isLoggedIn);
      show("loginLink",  !isLoggedIn);
      show("signupLinkMobile", !isLoggedIn);
      show("loginLinkMobile",  !isLoggedIn);
    });

    // ------- utilities -------
    function render(rows){
      boardEl.innerHTML = "";
      if (!rows.length) { boardEl.innerHTML = "<li>No users yet.</li>"; return; }
      rows.forEach((row, idx)=>{
        const li = document.createElement("li");
        const medal = idx===0 ? " ü•á" : idx===1 ? " ü•à" : idx===2 ? " ü•â" : "";
        li.innerHTML = `
          <div><span class="rank">${idx+1}</span> <span class="name">${row.name}</span>${medal}</div>
          <div class="points">${row.points||0} pts</div>`;
        boardEl.appendChild(li);
      });
    }

    // Query rfid_to_user for a given userId (requires .indexOn:["uid"])
    async function getRFIDForUser(userId){
      const q = query(ref(db, "rfid_to_user"), orderByChild("uid"), equalTo(userId));
      const snap = await get(q);
      if (!snap.exists()) return null;
      const obj = snap.val();
      return Object.keys(obj)[0] || null;
    }

    // cache of listeners so we can detach across refreshes
    const pointUnsubs = new Map(); // rfid -> unsubscribe

    function detachAllPoints(){
      for (const fn of pointUnsubs.values()) { try { fn(); } catch(_){} }
      pointUnsubs.clear();
    }

    // Build live leaderboard:
    // 1) watch /users
    // 2) for each user resolve RFID via rfid_to_user (query)
    // 3) attach live listener to linked_uids/<rfid>/points
    onValue(ref(db, "users"), async (usersSnap)=>{
      const users = usersSnap.exists() ? usersSnap.val() : {};
      const rows  = Object.entries(users).map(([uid, u]) => ({
        uid, name: (u?.name || u?.email || `User ${uid.slice(0,6)}`), points: 0, rfid: null
      }));

      // detach old point listeners
      detachAllPoints();

      // resolve RFIDs and subscribe to points
      const jobs = rows.map(async (row)=>{
        try{
          const rfid = await getRFIDForUser(row.uid);
          row.rfid = rfid;
          if (rfid){
            const pRef = ref(db, `linked_uids/${rfid}/points`);
            const unsub = onValue(pRef, (ps)=>{
              row.points = ps.exists()? ps.val() : 0;
              const sorted = [...rows].sort((a,b)=>(b.points||0)-(a.points||0));
              render(sorted);
            }, (err)=>{
              console.warn("points listener error:", err?.message);
            });
            pointUnsubs.set(rfid, unsub);
          } else {
            row.points = 0; // unlinked ‚Üí 0
          }
        } catch {
          row.points = 0;
        }
      });

      await Promise.all(jobs);
      const sorted = [...rows].sort((a,b)=>(b.points||0)-(a.points||0));
      render(sorted);
    }, (err)=>{
      boardEl.innerHTML = `<li>Error loading leaderboard: ${err?.message||"Must Be Logged In."}</li>`;
    });

    // nav helpers
    window.toggleMobileNav = ()=> document.getElementById("mobileDropdown").classList.toggle("show");
    window.checkLogin = (e)=>{
      const isLoggedIn = document.cookie.includes("loggedIn=true");
      if (!isLoggedIn) {
        e.preventDefault();
        const p = document.getElementById("popupMessage");
        p.style.display="block"; setTimeout(()=>p.style.display="none", 3500);
      }
    };
    window.logout = ()=> signOut(auth).then(()=>{ document.cookie="loggedIn=false; path=/"; location.href="login.html"; });
  </script>
</body>
</html>

