<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard ‚Äì EcoLife</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#0a192a; color:white; font-family:system-ui,sans-serif; margin:0; padding:0; }
    .topnav {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:1rem;
      background-color:#000;
      color:white;
      position:relative;
      z-index:10;
    }
    .gear { font-size:1.5rem; cursor:pointer; }
    .hamburger {
      display:none;
      font-size:1.5rem;
      background:none;
      border:none;
      color:white;
    }
    @media(max-width:600px){
      .hamburger{display:block;}
      .nav-dropdown{
        display:none; position:absolute; right:1rem; top:3.5rem;
        background:#073763; flex-direction:column; padding:1rem; border-radius:6px; z-index:999;
      }
      .nav-dropdown.show{display:flex;}
      .nav-dropdown a{color:white;margin:0.5rem 0;text-decoration:none;}
      .nav-dropdown a:hover{text-decoration:underline;}
    }
    #settingsPanel{display:none;position:fixed;top:4rem;left:1rem;background:#111;padding:1rem;border-radius:8px;z-index:1001;}
    .logout-btn{color:red;text-decoration:underline;background:none;border:none;margin-top:1rem;cursor:pointer;}
    #popupMessage{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background-color:#ff4444;color:white;padding:0.75rem 1.5rem;border-radius:5px;display:none;z-index:1002;}
    #popupMessage .close-btn{margin-left:1rem;cursor:pointer;}

    /* Leaderboard styling */
    ul#leaderboardList {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
      font-size: 1.1rem;
    }
    ul#leaderboardList li {
      margin: 0.5rem 0;
      padding: 0.75rem 1rem;
      background: #1d3b5c;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .rank { font-weight:bold; color:#84cc16; }
  </style>
</head>
<body>

<!-- TOP NAVIGATION -->
<nav class="topnav">
  <div class="nav-left"><span class="gear" onclick="window.location.href='profile.html'">‚öôÔ∏è</span></div>
  <div class="nav-center">EcoLife</div>
  <div class="nav-right desktop-links">
    <a href="index.html">About Us</a>
    <a href="products.html">Services</a>
    <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="signup.html" id="signupLink">Sign Up</a>
    <a href="login.html" id="loginLink">Login</a>
  </div>
  <button class="hamburger" onclick="toggleMobileNav()">‚ò∞</button>
</nav>

<!-- MOBILE DROPDOWN -->
<div class="nav-dropdown" id="mobileDropdown">
  <a href="index.html">About Us</a>
  <a href="products.html">Services</a>
  <a href="dashboard.html" onclick="checkLogin(event)">Dashboard</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="signup.html" id="signupLinkMobile">Sign Up</a>
  <a href="login.html" id="loginLinkMobile">Login</a>
</div>

<!-- SETTINGS PANEL -->
<div id="settingsPanel">
  <button class="logout-btn" onclick="logout()">Log Out</button>
</div>

<!-- LOGIN POPUP -->
<div id="popupMessage">
  You must be logged in to view the dashboard.
  <span class="close-btn" onclick="this.parentElement.style.display='none'">‚úï</span>
</div>

<!-- LEADERBOARD -->
<div class="auth-box" style="max-width: 800px; text-align: center;">
  <h1 style="margin-bottom: 1rem;">üèÜ Leaderboard</h1>
  <ul id="leaderboardList">
    <li>Loading leaderboard...</li>
  </ul>
</div>

<!-- FIREBASE LEADERBOARD LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
  authDomain: "ecolife--v1.firebaseapp.com",
  databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ecolife--v1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const leaderboardList = document.getElementById("leaderboardList");

// Show/hide login/signup links
onAuthStateChanged(auth, user => {
  const isLoggedIn = !!user;
  document.cookie = `loggedIn=${isLoggedIn}; path=/`;
  document.getElementById("signupLink").style.display = isLoggedIn ? "none" : "inline";
  document.getElementById("loginLink").style.display = isLoggedIn ? "none" : "inline";
  document.getElementById("signupLinkMobile").style.display = isLoggedIn ? "none" : "block";
  document.getElementById("loginLinkMobile").style.display = isLoggedIn ? "none" : "block";
});

// Fetch leaderboard based on linked RFIDs
async function fetchLeaderboard() {
  try {
    // 1. Get linked UIDs
    const linkedSnapshot = await get(ref(db, "linked_uids"));
    const linkedUsers = linkedSnapshot.val() || {};

    // 2. Map each linked UID to its RFID(s)
    const leaderboardData = [];

    for (const uid in linkedUsers) {
      const rfids = linkedUsers[uid] || [];
      let totalPoints = 0;

      // 3. Sum points from linked RFIDs
      for (const rfid of rfids) {
        const rfidSnapshot = await get(ref(db, `rfid_to_user/${rfid}`));
        const linkedUid = rfidSnapshot.val();
        if (linkedUid === uid) {
          const userSnapshot = await get(ref(db, `users/${uid}`));
          const points = userSnapshot.val()?.points || 0;
          totalPoints = points; // Assuming points stored per user; adjust if stored per RFID
        }
      }

      const userSnapshot = await get(ref(db, `users/${uid}`));
      const name = userSnapshot.val()?.name || userSnapshot.val()?.email || "User";
      leaderboardData.push({ name, points: totalPoints });
    }

    // Sort leaderboard
    leaderboardData.sort((a,b)=> b.points - a.points);

    // Render
    leaderboardList.innerHTML = "";
    if(leaderboardData.length === 0) {
      leaderboardList.innerHTML = "<li>No users yet.</li>";
      return;
    }
    leaderboardData.forEach((user,index)=>{
      const trophy = index===0?" ü•á":index===1?" ü•à":index===2?" ü•â":"";
      const li = document.createElement("li");
      li.innerHTML = `<span class="rank">${index+1}</span>. ${user.name}${trophy} <span>${user.points} pts</span>`;
      leaderboardList.appendChild(li);
    });

  } catch(err){
    console.error("Error fetching leaderboard:", err);
    leaderboardList.innerHTML = "<li>Error fetching leaderboard. Make sure you are logged in.</li>";
  }
}

// Initial fetch and update every 6 seconds
fetchLeaderboard();
setInterval(fetchLeaderboard, 6000);

// Helpers
window.logout = () => signOut(auth).then(()=>{ document.cookie="loggedIn=false; path=/"; location.href="login.html"; });
window.toggleMobileNav = () => document.getElementById("mobileDropdown").classList.toggle("show");
function checkLogin(event){
  const isLoggedIn = document.cookie.includes("loggedIn=true");
  if(!isLoggedIn){
    event.preventDefault();
    const popup = document.getElementById("popupMessage");
    popup.style.display="block";
    setTimeout(()=>popup.style.display="none",4000);
  }
}
</script>

</body>
</html>
