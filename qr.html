<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate QR</title>
  <style>
    body { background-color: #111; color: white; font-family: sans-serif; text-align: center; padding: 2rem; }
    #qrCode { margin-top: 2rem; }
    input, button { padding: 0.5rem 1rem; margin-top: 1rem; font-size: 1rem; }
    button { cursor: pointer; background-color: #073763; color: white; border: none; border-radius: 6px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW5APPZMu-lojVRNg89ZDBEY14YD77xd4",
      authDomain: "ecolife--v1.firebaseapp.com",
      databaseURL: "https://ecolife--v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ecolife--v1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Select HTML elements ---
    const qrContainer = document.getElementById("qrCode");
    const uidInput = document.getElementById("uidInput");
    const generateBtn = document.getElementById("generateBtn");

    // --- Generate QR Function ---
    async function generateQR(uid) {
      if (!uid) return;
      qrContainer.innerHTML = ""; // clear old QR
      try {
        const qrData = uid; // You can include JSON here if needed
        QRCode.toCanvas(qrContainer, qrData, { width: 300, color: { dark: "#073763", light: "#111" } });
      } catch (err) {
        console.error("QR Generation Error:", err);
      }
    }

    // --- Handle manual UID input ---
    generateBtn.addEventListener("click", () => {
      const uid = uidInput.value.trim();
      generateQR(uid);
    });

    // --- Auto-generate latest UID from Firebase ---
    onValue(ref(db, "unlinked_uids"), snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const latestUID = Object.keys(data)[Object.keys(data).length - 1];
      generateQR(latestUID);
      uidInput.value = latestUID;
    });

  </script>
</head>
<body>
  <h1>RFID QR Code Generator</h1>
  <p>Scan this QR code to link your RFID card to the dashboard.</p>
  <input type="text" id="uidInput" placeholder="Enter UID manually if needed">
  <button id="generateBtn">Generate QR</button>
  <div id="qrCode"></div>
</body>
</html>
